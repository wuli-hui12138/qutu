#!/bin/bash

# =================================================================
# è¶£å›¾åŒ£å­ (Qutu) ä¸€é”®éƒ¨ç½²è„šæœ¬
# é€‚ç”¨ç¯å¢ƒ: Linux / å®å¡”é¢æ¿
# åŠŸèƒ½: å®‰è£…ä¾èµ– -> ç”ŸæˆPrisma -> æ•°æ®åº“è¿ç§» -> é¡¹ç›®æ‰“åŒ…
# =================================================================

set -e # é‡åˆ°ä»»ä½•é”™è¯¯ç«‹å³åœæ­¢æ‰§è¡Œ

echo "ğŸš€ å¼€å§‹ä¸€é”®éƒ¨ç½²æµç¨‹..."

# 1. å®‰è£…æ‰€æœ‰ä¾èµ–
echo "ğŸ“¦ æ­£åœ¨å®‰è£…ä¾èµ– ..."
npm run install:all

# 2. ç”Ÿæˆ Prisma Client
echo "ğŸ’ æ­£åœ¨ç”Ÿæˆ Prisma Client..."
cd backend
npx prisma generate

# 3. æ‰§è¡Œæ•°æ®åº“åŒæ­¥
echo "ğŸ—„ï¸ æ­£åœ¨é€šè¿‡ db push åŒæ­¥æ•°æ®æ¨¡å‹..."
# ä½¿ç”¨ db push ç»•è¿‡æ—§è¿ç§»å†å²ï¼Œç›´æ¥å¯¹é½ MySQL ç»“æ„
npx prisma db push --accept-data-loss
cd ..

# 4. æ„å»ºé¡¹ç›®
echo "ğŸ—ï¸ æ­£åœ¨æ‰§è¡Œå…¨é‡æ„å»º..."
# ç¡®ä¿ package.json ä¸­æœ‰ build:all è„šæœ¬
npm run build:all

echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo "ğŸ’¡ æç¤ºï¼šåç«¯äº§ç‰©åœ¨ backend/distï¼Œå‰ç«¯äº§ç‰©åœ¨ distã€‚"
echo "ğŸ’¡ è¿è¡Œï¼šcd backend && pm2 start dist/main.js --name qutu-api"
